
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Regras para a coleção 'users'
    match /users/{userId} {
      
      // Leitura: Qualquer usuário autenticado pode ler perfis para funcionalidades do app (ex: dashboard).
      allow read: if request.auth != null;

      // Criação: Um usuário pode criar seu próprio perfil. Essencial para o primeiro login.
      // Admins podem criar outros usuários através da tela de gerenciamento.
      allow create: if request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';

      // Atualização e Exclusão: Apenas administradores podem modificar ou remover perfis.
      allow update, delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Regras para a coleção 'registros'
    match /registros/{registroId} {

      // Leitura e Criação: Qualquer usuário autenticado pode ler e registrar temperaturas.
      allow read, create: if request.auth != null;

      // Atualização e Exclusão: Apenas administradores podem alterar ou apagar registros.
      allow update, delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
